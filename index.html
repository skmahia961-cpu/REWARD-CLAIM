<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REWARD CLAIM</title>
<meta name="monetag" content="a41ceca9ffc67edad031c0024f85ef59">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: { sans: ['Poppins', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] },
                colors: {
                    nexus: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        primary: '#6366f1',
                        accent: '#06b6d4',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    }
</script>
<style>
    :root { --nexus-bg: #0f172a; --nexus-card: #1e293b; --primary-grad: linear-gradient(135deg, #6366f1, #8b5cf6); }
    body { background-color: var(--nexus-bg); color: #e2e8f0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
    .no-select { -webkit-user-select: none; user-select: none; }
    .allow-select { -webkit-user-select: text; user-select: text; }
    .neo-card {
        background: var(--nexus-card); border: 1px solid #334155;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: transform 0.2s, border-color 0.2s;
    }
    .neo-card:active { transform: scale(0.98); }
    .neo-input {
        background: #0f172a; border: 1px solid #334155; color: #fff; transition: all 0.3s ease;
    }
    .neo-input:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); outline: none; }
    .action-btn {
        background: var(--primary-grad); color: white; font-weight: 600; border: none;
        position: relative; overflow: hidden; transition: all 0.3s ease;
    }
    .action-btn::after {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(rgba(255,255,255,0.2), rgba(255,255,255,0));
        opacity: 0; transition: opacity 0.3s;
    }
    .action-btn:active { transform: scale(0.97); }
    .action-btn:hover::after { opacity: 1; }
    .action-btn:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
    .action-btn:disabled::after { display: none; }
    .app-view { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
    .app-view.active-view { display: block; opacity: 1; transform: translateY(0); }
    .dock-nav {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        width: 95%; max-width: 400px; background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);
        display: flex; justify-content: space-evenly; padding: 12px; z-index: 50;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
    }
    .dock-item {
        color: #94a3b8; display: flex; flex-direction: column; align-items: center;
        font-size: 10px; gap: 4px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative; padding: 0 8px;
    }
    .dock-item.nav-active { color: #6366f1; transform: translateY(-4px); }
    .dock-item.nav-active::after {
        content: ''; position: absolute; bottom: -8px; width: 6px; height: 6px;
        background: #6366f1; border-radius: 50%;
    }
    #splash-screen {
        position: fixed; inset: 0; background: var(--nexus-bg); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: opacity 0.5s ease;
    }
    .loader-ring {
        width: 60px; height: 60px; border: 4px solid #1e293b; border-top-color: #22c55e;
        border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .side-panel-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
        opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 80;
    }
    .side-panel {
        position: fixed; left: 0; top: 0; bottom: 0; width: 85%; max-width: 320px;
        background: var(--nexus-bg); z-index: 90; transform: translateX(-105%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); border-right: 1px solid #334155;
    }
    .side-panel.open { transform: translateX(0); }
    .side-panel-overlay.open { opacity: 1; visibility: visible; }
    .glass-modal {
        background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
        border: 1px solid rgba(99, 102, 241, 0.2); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .task-update-btn {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        z-index: 1;
    }
    .task-update-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300%;
        height: 300%;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(0);
        transition: transform 0.6s ease;
        z-index: -1;
    }
    .task-update-btn:hover::before {
        transform: translate(-50%, -50%) scale(1);
    }
    .task-update-btn:hover {
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
        transform: translateY(-2px);
    }
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 5px #6366f1, 0 0 10px #6366f1, 0 0 15px #8b5cf6; }
        50% { box-shadow: 0 0 10px #8b5cf6, 0 0 20px #8b5cf6, 0 0 30px #6366f1; }
    }
    .animated-task-button {
        animation: pulse-glow 2.5s infinite ease-in-out;
    }
    @keyframes fade-in-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-down { animation: fade-in-down 0.5s ease forwards; }
</style>
</head>
<body class="max-w-md mx-auto min-h-screen overflow-x-hidden no-select pb-28">

<!-- SPLASH SCREEN -->
<div id="splash-screen">
    <div class="relative">
        <div class="loader-ring"></div>
        <div class="absolute inset-0 flex items-center justify-center">
            <i data-lucide="dollar-sign" class="w-6 h-6 text-green-500"></i>
        </div>
    </div>
    <h1 class="mt-6 text-2xl font-bold tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-green-600">REWARD CLAIM</h1>
    <p id="loading-msg" class="text-slate-500 text-sm mt-2 animate-pulse">Establishing Secure Connection...</p>
</div>

<!-- SIDE PANEL -->
<div class="side-panel-overlay" id="panel-overlay"></div>
<aside class="side-panel" id="main-side-panel">
    <div class="p-6 bg-slate-900/50 border-b border-slate-800">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-tr from-indigo-600 to-cyan-500 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <i data-lucide="shield-check" class="w-7 h-7 text-white"></i>
            </div>
            <div>
                <h3 class="font-bold text-lg text-slate-100">Help Center</h3>
                <p class="text-xs text-slate-400">24/7 Priority Support</p>
            </div>
        </div>
    </div>
    <div id="panel-content" class="p-4 space-y-2 overflow-y-auto h-[calc(100%-160px)]">
        <!-- New Menu Items -->
        <button onclick="closeSidePanel(); switchView('view-deposit');" class="neo-card w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-emerald-500/10 text-emerald-500"><i data-lucide="arrow-down-left" class="w-5 h-5"></i></div>
                <span class="font-medium">Deposit</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
         <button onclick="closeSidePanel(); switchView('view-withdrawal');" class="neo-card w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-cyan-500/10 text-cyan-500"><i data-lucide="arrow-up-right" class="w-5 h-5"></i></div>
                <span class="font-medium">Withdrawal</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="openSupport()" class="neo-card w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
             <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-blue-500/10 text-blue-500"><i data-lucide="life-buoy" class="w-5 h-5"></i></div>
                <span class="font-medium">Support Hub</span>
            </div>
            <i data-lucide="external-link" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="visitWebsite()" class="neo-card w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-purple-500/10 text-purple-500"><i data-lucide="globe" class="w-5 h-5"></i></div>
                <span class="font-medium">Visit Website</span>
            </div>
            <i data-lucide="external-link" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="openPremiumPage()" class="neo-card w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition mt-4 border-t border-slate-800 pt-6">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-yellow-500/10 text-yellow-500"><i data-lucide="gem" class="w-5 h-5"></i></div>
                <span class="font-medium">Get Premium</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
    </div>
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-800 bg-slate-900">
        <p class="text-center text-[10px] text-slate-600 tracking-widest">REWARD v4.8.1 encrypted</p>
    </div>
</aside>

<!-- MAIN APP CONTAINER -->
<div id="nexus-app" class="min-h-screen">
<!-- TOP BAR -->
<header class="sticky top-0 z-40 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3" id="user-quick-info">
        <div class="relative">
            <img id="nav-user-img" src="" class="w-10 h-10 rounded-full border-2 border-indigo-500/30 hidden object-cover" alt="User">
            <div id="nav-user-initials" class="w-10 h-10 rounded-full bg-slate-800 border-2 border-slate-700 flex items-center justify-center font-bold text-slate-400">U</div>
            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-slate-900 rounded-full"></div>
        </div>
        <div>
            <p id="welcome-text" class="text-xs text-slate-400 font-medium">Welcome back,</p>
            <p id="user-balance-top" class="text-sm font-bold text-emerald-400">$0.00</p>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <button onclick="switchView('view-deposit')" class="action-btn px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1.5 shadow-lg shadow-indigo-500/20">
            <i data-lucide="plus" class="w-4 h-4"></i>FUND
        </button>
        <button id="btn-notifications" class="relative p-2 text-slate-400 hover:text-slate-200 transition bg-slate-800/50 rounded-full">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span id="badge-notify" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 border-2 border-slate-900 rounded-full hidden"></span>
        </button>
        <button id="btn-menu" class="p-2 text-slate-400 hover:text-slate-200 transition">
            <i data-lucide="align-right" class="w-6 h-6"></i>
        </button>
    </div>
</header>

<main class="p-4">

<!-- DASHBOARD VIEW -->
<div id="view-dashboard" class="app-view active-view space-y-6">
    <!-- Promo Slider -->
    <div class="neo-card rounded-2xl overflow-hidden relative aspect-video">
        <div id="promo-slider" class="h-full flex transition-transform duration-500 ease-out">
             <div class="min-w-full h-full bg-slate-800 relative">
                <img src="https://i.postimg.cc/WFHWMxP3/Yellow-Orange-Modern-Marketing-Courses-You-Tube-Thumbnail-20250910-185659-0000.png" class="w-full h-full object-cover opacity-80" alt="Promo 1">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
            </div>
             <div class="min-w-full h-full bg-slate-800 relative">
                <img src="https://i.postimg.cc/W1syFD8p/Grey-Blue-Illustration-Refer-a-Friend-Instagram-Post-1080-x-720-px-20250917-223749-0000.png" class="w-full h-full object-cover opacity-80" alt="Promo 2">
            </div>
        </div>
        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2" id="slider-dots">
            <span class="w-2 h-2 rounded-full bg-white"></span><span class="w-2 h-2 rounded-full bg-slate-600"></span>
        </div>
    </div>

<!-- Main Balance Card -->
<div class="neo-card p-6 rounded-3xl bg-gradient-to-br from-slate-800 to-slate-900 relative overflow-hidden">
    <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl"></div>
    <p class="text-slate-400 font-medium mb-2 flex items-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> Available Balance</p>
    <h2 id="main-balance-display" class="text-4xl font-bold text-white tracking-tight mb-6">$0.00</h2>
    <div class="grid grid-cols-2 gap-3">
        <button onclick="switchView('view-deposit')" class="action-btn py-3 rounded-xl flex items-center justify-center gap-2">
            <i data-lucide="plus-circle" class="w-5 h-5"></i> DEPOSIT
        </button>
         <button onclick="switchView('view-withdrawal')" class="action-btn py-3 rounded-xl flex items-center justify-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500">
            <i data-lucide="arrow-up-circle" class="w-5 h-5"></i> WITHDRAW
        </button>
    </div>
</div>

<!-- Live Withdrawal Feed -->
<div id="live-withdrawal-feed" class="space-y-3">
    <h3 class="text-lg font-semibold text-slate-300 px-2 flex items-center gap-2">
        <i data-lucide="arrow-up-right" class="w-5 h-5 text-cyan-400"></i>
        Live Withdrawals
    </h3>
    <div id="withdrawal-feed-container" class="h-48 overflow-hidden relative space-y-3">
        <!-- Feed items will be injected here -->
    </div>
</div>
</div>

<!-- TASKS VIEW -->
<div id="view-tasks" class="app-view space-y-6">
    <div class="text-center">
       <h2 class="text-2xl font-bold text-slate-100">Daily Tasks</h2>
       <p class="text-slate-500 text-sm">Complete simple tasks to earn rewards</p>
   </div>
   <div id="task-list" class="space-y-4">
       <!-- Tasks will be dynamically inserted here -->
   </div>
</div>

<!-- REFER VIEW (Improved) -->
<div id="view-refer" class="app-view space-y-6">
    <!-- Enter Referral Code -->
    <div id="referral-input-section" class="neo-card p-5 rounded-2xl text-center space-y-3">
        <h3 class="font-semibold text-slate-200 text-lg">Have a Referral Code?</h3>
        <p class="text-xs text-slate-400">Enter your friend's code below. You both will receive <span id="referral-bonus-text" class="text-emerald-400 font-bold">$1.00</span> instantly!</p>
        <div class="relative">
            <input type="text" id="referral-code-input" placeholder="Enter Code Here" class="neo-input w-full p-3 rounded-xl text-center font-mono">
        </div>
        <button id="btn-verify-referral" class="action-btn w-full py-3 rounded-xl">VERIFY & CLAIM <span id="referral-claim-bonus-text">$1.00</span></button>
    </div>

<div class="grid grid-cols-2 gap-4 text-center">
    <div class="neo-card p-4 rounded-xl">
        <p class="text-sm text-slate-400">Total Referrals</p>
        <p id="ref-stat-count" class="text-2xl font-bold text-white">0</p>
    </div>
    <div class="neo-card p-4 rounded-xl">
        <p class="text-sm text-slate-400">Referral Earnings</p>
        <p id="ref-stat-earnings" class="text-2xl font-bold text-emerald-400">$0.00</p>
    </div>
</div>

<div class="neo-card p-5 rounded-2xl text-center">
    <h3 class="font-semibold text-slate-300 mb-2">Your Unique Referral Link</h3>
    <div class="relative">
        <input type="text" id="referral-link-display" readonly class="neo-input w-full p-3 rounded-xl text-center bg-slate-900 font-mono text-sm" value="Loading...">
        <button onclick="copyText(document.getElementById('referral-link-display').value)" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-700">
            <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i>
        </button>
    </div>
</div>

<div class="grid grid-cols-2 gap-4">
    <button onclick="shareOnTelegram()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-[#2AABEE] text-white font-semibold">
        <i data-lucide="send" class="w-5 h-5"></i> Telegram
    </button>
     <button onclick="shareLive()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-purple-600 text-white font-semibold">
        <i data-lucide="share-2" class="w-5 h-5"></i> Share Live
    </button>
</div>

<div class="neo-card p-5 rounded-xl text-left">
    <h3 class="font-semibold text-slate-200 mb-3 flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5 text-indigo-400"></i> How it Works:</h3>
    <ul class="space-y-3 text-sm text-slate-400">
        <li class="flex items-start gap-3"><i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-1 shrink-0"></i> <span>Enter a friend's code once to get a bonus for both of you.</span></li>
        <li class="flex items-start gap-3"><i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-1 shrink-0"></i> <span>Share your unique link with friends.</span></li>
        <li class="flex items-start gap-3"><i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-1 shrink-0"></i> <span>You earn a commission on their every deposit, forever.</span></li>
        <li class="flex items-start gap-3"><i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-1 shrink-0"></i> <span>The more friends you invite, the more you earn passively.</span></li>
    </ul>
</div>

<!-- Live Referral Feed -->
<div id="live-referral-feed" class="space-y-3">
    <h3 class="text-lg font-semibold text-slate-300 px-2 flex items-center gap-2">
        <i data-lucide="award" class="w-5 h-5 text-emerald-400"></i>
        Live Referrals
    </h3>
    <div id="referral-feed-container" class="h-48 overflow-hidden relative space-y-3">
        <!-- Feed items will be injected here -->
    </div>
</div>
</div>

<!-- DEPOSIT VIEW -->
<div id="view-deposit" class="app-view space-y-6">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-slate-100">Add Funds</h2>
        <p class="text-slate-500 text-sm">Secure & Fast Balance Top-up</p>
    </div>
    <div class="neo-card p-5 rounded-2xl border-indigo-500/30 bg-indigo-500/5">
        <div class="flex items-start gap-3">
            <i data-lucide="alert-circle" class="w-6 h-6 text-indigo-400 shrink-0 mt-1"></i>
            <div>
                 <h4 class="font-bold text-indigo-300 mb-1">IMPORTANT NOTE</h4>
                 <p class="text-xs text-indigo-200/70 leading-relaxed">
                    Please use a valid payment method. Minimum deposit is <span id="min-deposit-text" class="text-white font-bold">$10.00</span>.
                 </p>
            </div>
        </div>
    </div>
    <div class="grid grid-cols-3 gap-3 text-center">
         <div class="neo-card p-3 rounded-xl flex flex-col items-center" onclick="copyNumber('0x82f67a0590e10f679c062f8e2c235af4ea980bc9', 'USDT')">
             <img src="https://i.postimg.cc/dkyYkPk2/usdt-logo.png" class="w-8 h-8 mb-2 rounded-full" alt="USDT">
             <span class="font-mono text-xs text-slate-300">USDT (TRC20)</span>
             <span class="text-[10px] text-slate-500 mt-1">Tap to Copy</span>
         </div>
         <div class="neo-card p-3 rounded-xl flex flex-col items-center" onclick="copyNumber('1RBJu6cHBetMCYHxDZH1x8nw41buXVxJX', 'BTC')">
             <img src="https://i.postimg.cc/gxWnGs7Z/btc-logo.png" class="w-8 h-8 mb-2 rounded-full" alt="BTC">
             <span class="font-mono text-xs text-slate-300">Bitcoin</span>
             <span class="text-[10px] text-slate-500 mt-1">Tap to Copy</span>
         </div>
         <div class="neo-card p-3 rounded-xl flex flex-col items-center" onclick="copyNumber('900749799', 'Binance')">
             <img src="https://i.postimg.cc/21r8s6bf/binance-logo.png" class="w-8 h-8 mb-2 rounded-full bg-white p-1" alt="Binance">
             <span class="font-mono text-xs text-slate-300">Binance Pay</span>
             <span class="text-[10px] text-slate-500 mt-1">Tap to Copy</span>
         </div>
    </div>
    <div class="neo-card p-5 rounded-2xl space-y-4">
        <h3 class="font-semibold text-slate-200">Submit Verification Info</h3>
        <input type="hidden" id="dep-method" value="">
        <button id="dep-method-selector" class="neo-input w-full p-3 rounded-xl text-left text-slate-400 flex justify-between items-center">
            <span id="dep-method-text">Select Payment Method</span>
            <i data-lucide="chevron-down" class="w-5 h-5"></i>
        </button>
        <input type="number" id="dep-amount" placeholder="Amount (USD)" class="neo-input w-full p-3 rounded-xl">
        <input type="text" id="dep-sender" placeholder="Your Wallet Address / Binance ID" class="neo-input w-full p-3 rounded-xl">
        <button id="btn-submit-deposit" class="action-btn w-full py-4 rounded-xl text-lg shadow-lg shadow-indigo-500/20">VERIFY DEPOSIT</button>
    </div>
    <div class="pt-4">
        <h3 class="text-sm font-bold text-slate-400 mb-3 px-2">Transaction History</h3>
        <div id="deposit-history-log" class="space-y-2"></div>
    </div>
</div>

<!-- WITHDRAWAL VIEW (New) -->
<div id="view-withdrawal" class="app-view space-y-6">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-slate-100">Withdraw Funds</h2>
        <p class="text-slate-500 text-sm">Request a withdrawal to your wallet</p>
    </div>
    <div class="neo-card p-5 rounded-2xl border-cyan-500/30 bg-cyan-500/5">
        <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-6 h-6 text-cyan-400 shrink-0 mt-1"></i>
            <div>
                 <h4 class="font-bold text-cyan-300 mb-1">WITHDRAWAL INFO</h4>
                 <p id="withdrawal-info-text" class="text-xs text-cyan-200/70 leading-relaxed">
                    Withdrawals are processed within 24 hours. Minimum withdrawal is <span id="min-withdrawal-text" class="text-white font-bold">$5.00</span>.
                 </p>
            </div>
        </div>
    </div>

<div class="neo-card p-5 rounded-2xl space-y-4">
    <h3 class="font-semibold text-slate-200">Enter Withdrawal Details</h3>
    <input type="hidden" id="wd-method" value="">
    <button id="wd-method-selector" class="neo-input w-full p-3 rounded-xl text-left text-slate-400 flex justify-between items-center">
        <span id="wd-method-text">Select Withdrawal Method</span>
        <i data-lucide="chevron-down" class="w-5 h-5"></i>
    </button>
    <input type="text" id="wd-address" placeholder="Your Wallet Address / Binance ID" class="neo-input w-full p-3 rounded-xl">
    <input type="number" id="wd-amount" placeholder="Amount to Withdraw (USD)" class="neo-input w-full p-3 rounded-xl">
    
    <button id="btn-submit-withdrawal" class="action-btn w-full py-4 rounded-xl text-lg bg-gradient-to-r from-cyan-500 to-blue-500 shadow-lg shadow-cyan-500/20">SUBMIT WITHDRAWAL</button>
</div>
<div class="pt-4">
    <h3 class="text-sm font-bold text-slate-400 mb-3 px-2">Withdrawal History</h3>
    <div id="withdrawal-history-log" class="space-y-2"></div>
</div>
</div>

<!-- PROFILE VIEW -->
<div id="view-profile" class="app-view space-y-6">
    <div class="flex flex-col items-center pt-6">
         <div class="relative mb-4">
            <div class="w-28 h-28 rounded-full p-1 bg-gradient-to-tr from-indigo-500 to-cyan-500">
                 <img id="profile-user-img" src="" class="w-full h-full rounded-full bg-slate-900 object-cover p-1 hidden" alt="Profile">
                 <div id="profile-user-initials" class="w-full h-full rounded-full bg-slate-800 flex items-center justify-center text-4xl font-bold text-slate-500 border-4 border-slate-900"></div>
            </div>
        </div>
        <div id="profile-name-display" class="text-2xl font-bold text-white text-center flex items-center gap-2">Loading...</div>
        <button id="btn-copy-uid" class="mt-2 text-xs text-slate-400 bg-slate-800/50 px-3 py-1 rounded-full flex items-center gap-1 hover:bg-slate-800 transition">
            UID: <span id="uid-display">...</span> <i data-lucide="copy" class="w-3 h-3"></i>
        </button>
    </div>
    <div class="grid grid-cols-3 gap-3 text-center">
        <div class="neo-card p-3 rounded-xl bg-slate-800/50">
            <p class="text-[11px] text-slate-500 uppercase">Total Complete Tasks</p>
            <p id="stat-tasks" class="text-md font-bold text-cyan-400">0</p>
        </div>
        <div class="neo-card p-3 rounded-xl bg-slate-800/50">
            <p class="text-[11px] text-slate-500 uppercase">Total Income</p>
            <p id="stat-income" class="text-md font-bold text-yellow-400">$0.00</p>
        </div>
        <div class="neo-card p-3 rounded-xl bg-slate-800/50">
            <p class="text-[11px] text-slate-500 uppercase">Total Refer</p>
            <p id="stat-referrals" class="text-md font-bold text-emerald-400">0</p>
        </div>
    </div>
    <div class="space-y-3">
        <button onclick="switchView('view-features')" class="neo-card w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-orange-500/10 text-orange-500"><i data-lucide="zap" class="w-5 h-5"></i></div>
                <span class="font-medium">Advanced Features</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="openSupport()" class="neo-card w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
             <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-cyan-500/10 text-cyan-500"><i data-lucide="life-buoy" class="w-5 h-5"></i></div>
                <span class="font-medium">Support Hub</span>
            </div>
            <i data-lucide="external-link" class="w-5 h-5 text-slate-600"></i>
        </button>
    </div>
</div>

 <!-- FEATURES VIEW (Transfer) -->
<div id="view-features" class="app-view space-y-6">
     <div class="flex items-center gap-3 mb-6">
        <button onclick="switchView('view-profile')" class="p-2 rounded-full bg-slate-800 text-slate-400"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
        <h2 class="text-xl font-bold">Tools & Services</h2>
    </div>
    <div class="grid grid-cols-2 gap-4">
        <button onclick="switchView('subview-send')" class="neo-card p-5 rounded-2xl flex flex-col items-center gap-3 hover:border-indigo-500 transition group">
            <div class="w-14 h-14 rounded-full bg-indigo-500/10 flex items-center justify-center group-hover:bg-indigo-500 group-hover:text-white transition-all text-indigo-500">
                <i data-lucide="send" class="w-7 h-7 ml-1"></i>
            </div>
            <span class="font-semibold">P2P Transfer</span>
        </button>
        <button onclick="switchView('view-premium')" class="neo-card p-5 rounded-2xl flex flex-col items-center gap-3 hover:border-yellow-500 transition group">
            <div class="w-14 h-14 rounded-full bg-yellow-500/10 flex items-center justify-center group-hover:bg-yellow-500 group-hover:text-white transition-all text-yellow-500">
                <i data-lucide="gem" class="w-7 h-7"></i>
            </div>
            <span class="font-semibold">Premium</span>
        </button>
    </div>
    <div class="neo-card p-5 rounded-2xl mt-4 bg-slate-800/30">
         <h3 class="font-bold text-slate-300 mb-4 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4"></i> Recent Activities</h3>
         <div id="activity-log" class="space-y-3 text-sm text-slate-500 text-center py-4 max-h-60 overflow-y-auto">
             No recent activities found.
         </div>
    </div>
</div>

<!-- SUBVIEW: P2P SEND -->
<div id="subview-send" class="app-view space-y-6">
     <div class="flex items-center gap-3 mb-6">
        <button onclick="switchView('view-features')" class="p-2 rounded-full bg-slate-800 text-slate-400"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
        <h2 class="text-xl font-bold">Transfer Balance</h2>
    </div>
    <div class="neo-card p-6 rounded-3xl space-y-5">
        <div class="bg-yellow-500/10 text-yellow-500 p-3 rounded-xl text-sm flex gap-2 items-start">
            <i data-lucide="alert-triangle" class="w-5 h-5 shrink-0"></i>
            <p>Default transfer fee is <strong>5%</strong>. Minimum transfer is <strong>$0.50</strong>. Premium members get fee discounts.</p>
        </div>
        <div>
            <label class="text-xs text-slate-400 ml-2 mb-1 block">Recipient UID</label>
            <input type="text" id="p2p-uid" placeholder="Enter User ID" class="neo-input w-full p-4 rounded-xl font-mono">
        </div>
         <div>
            <label class="text-xs text-slate-400 ml-2 mb-1 block">Amount</label>
            <input type="number" id="p2p-amount" placeholder="0.00" class="neo-input w-full p-4 rounded-xl font-bold text-lg">
            <p id="p2p-fee-calc" class="text-right text-xs text-slate-500 mt-2 h-4"></p>
        </div>
        <button id="btn-exec-p2p" class="action-btn w-full py-4 rounded-xl text-lg">CONFIRM TRANSFER</button>
    </div>
</div>
   <!-- GET PREMIUM VIEW -->
<div id="view-premium" class="app-view space-y-6">
    <div class="flex items-center gap-3 mb-6">
       <button onclick="switchView('view-profile')" class="p-2 rounded-full bg-slate-800 text-slate-400"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
       <h2 class="text-xl font-bold">Premium Membership</h2>
    </div>
    <div id="premium-tiers-container" class="space-y-4">
        <!-- Tiers will be dynamically loaded here -->
    </div>
</div>

<!-- NEWS VIEW -->
<div id="view-news" class="app-view space-y-4">
    <h2 class="text-2xl font-bold px-2">Latest News</h2>
    <div id="news-feed" class="space-y-4">
        <!-- News will be loaded here from Firebase -->
    </div>
</div>
</main>

<!-- DOCK NAVIGATION -->
<nav class="dock-nav">
    <button class="dock-item nav-active" data-target="view-dashboard">
        <i data-lucide="home" class="w-6 h-6"></i>
        <span>Home</span>
    </button>
    <button class="dock-item" data-target="view-tasks">
        <i data-lucide="clipboard-check" class="w-6 h-6"></i>
        <span>Tasks</span>
    </button>
     <button class="dock-item" data-target="view-refer">
        <i data-lucide="users" class="w-6 h-6"></i>
        <span>Refer</span>
    </button>
    <button class="dock-item" data-target="view-news">
        <i data-lucide="rss" class="w-6 h-6"></i>
        <span>News</span>
    </button>
    <button class="dock-item" data-target="view-profile">
        <i data-lucide="user-circle" class="w-6 h-6"></i>
        <span>Account</span>
    </button>
</nav>
</div>

<!-- GENERIC MODAL -->
<div id="nexus-modal" class="fixed inset-0 z-[200] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="modal-backdrop"></div>
    <div class="glass-modal w-full max-w-sm p-6 rounded-3xl relative transform scale-95 transition-all duration-300" id="modal-content">
        <div id="modal-body"></div>
        <button id="modal-close" class="absolute top-4 right-4 p-1 rounded-full bg-slate-800 text-slate-400 hover:text-white">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, runTransaction, onSnapshot, updateDoc, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- CONFIGURATION ---
    let MIN_DEPOSIT_AMT = 10; 
    let MIN_WITHDRAWAL_AMT = 5;
    let MIN_REFERRALS_FOR_WITHDRAWAL = 2;
    let REFERRAL_BONUS = 1;
    let TASK_REWARD = 0.5;
    const P2P_FEE_PERCENT = 0.05; // 5%
    const MIN_P2P_AMT = 0.5;
    const ADMIN_ID = "CUb4r6eg1RV6Ljkj5U2V1cSswng1";
    
    // --- PREMIUM TIER CONFIGURATION (DEFAULTS) ---
    let premiumTiers = {
        plan0: { name: 'Free', price: 0,  level: 0, duration: 3, taskLimit: 1, benefits: { feeReduction: 0, benefit_text_1: "Daily Task Limit: 1" } },
        plan1: { name: 'Plan 1', price: 10,  level: 1, duration: 30, taskLimit: 2, benefits: { feeReduction: 0.01, benefit_text_1: "Daily Task Limit: 2" } },
        plan2: { name: 'Plan 2', price: 20,  level: 2, duration: 30, taskLimit: 4, benefits: { feeReduction: 0.02, benefit_text_1: "Daily Task Limit: 4" } },
        plan3: { name: 'Plan 3', price: 30, level: 3, duration: 30, taskLimit: 6, benefits: { feeReduction: 0.03, benefit_text_1: "Daily Task Limit: 6" } },
        plan4: { name: 'Plan 4', price: 40, level: 4, duration: 30, taskLimit: 8, benefits: { feeReduction: 0.04, benefit_text_1: "Daily Task Limit: 8" } },
        plan5: { name: 'Plan 5', price: 50, level: 5, duration: 30, taskLimit: 10, benefits: { feeReduction: 0.05, benefit_text_1: "Daily Task Limit: 10" } }
    };

    // FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyBvbP66g1BYLQEj2XOJRA21meZN4ioJKpc",
  authDomain: "reward-claim-2cc72.firebaseapp.com",
  databaseURL: "https://reward-claim-2cc72-default-rtdb.firebaseio.com",
  projectId: "reward-claim-2cc72",
  storageBucket: "reward-claim-2cc72.firebasestorage.app",
  messagingSenderId: "158110437555",
  appId: "1:158110437555:web:e7c671b33fc0b7b24120c6"
};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let tgSession = null;
    let userData = null;
    let sysConfig = {};
    let activeTimers = []; 
    let firebaseUser = null;

    // --- CORE FUNCTIONS ---
    window.onload = async () => {
        try {
            if(window.Telegram?.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.setHeaderColor('#0f172a');
                window.Telegram.WebApp.setBackgroundColor('#0f172a');
                if (window.Telegram.WebApp.initDataUnsafe?.user) {
                    tgSession = window.Telegram.WebApp.initDataUnsafe.user;
                }
            }
        } catch (e) { 
            console.error("Telegram WebApp initialization failed:", e); 
        }

        if (!tgSession) {
            document.body.innerHTML = `
            <div class="flex flex-col items-center justify-center h-screen text-center p-4">
                <div class="neo-card p-8 rounded-2xl w-full max-w-sm">
                    <i data-lucide="alert-triangle" class="w-16 h-16 mb-4 mx-auto text-red-500"></i>
                    <h1 class="text-2xl font-bold text-red-400">Authentication Failed</h1>
                    <p class="text-slate-400 text-sm font-normal mt-2">Could not identify user. Please launch this app through the official Telegram bot.</p>
                </div>
            </div>`;
            lucide.createIcons();
            return;
        }

        try {
            const userCredential = await signInAnonymously(auth);
            firebaseUser = userCredential.user;
            await initializeAppLogic();
        } catch (error) {
            console.error("Firebase Anonymous Auth Failed:", error);
            document.getElementById('loading-msg').innerText = 'Connection Error. Please restart.';
        }
    };

    async function initializeAppLogic() {
        await loadConfig();
        await initSession();
        setupInteractions();
        lucide.createIcons();
        initLiveWithdrawalFeed();

        document.getElementById('splash-screen').style.opacity = '0';
        setTimeout(() => document.getElementById('splash-screen').remove(), 500);
    }

    async function initSession() {
        const uid = String(tgSession.id);
        const userRef = doc(db, "users", uid);
        const snap = await getDoc(userRef);

        if (snap.exists()) {
            userData = snap.data();
            if (!userData.firebaseUid || userData.firebaseUid !== firebaseUser.uid) {
                await updateDoc(userRef, { firebaseUid: firebaseUser.uid });
                userData.firebaseUid = firebaseUser.uid;
            }
        } else {
            userData = {
                tgChatId: uid,
                firebaseUid: firebaseUser.uid,
                name: `${tgSession.first_name} ${tgSession.last_name || ''}`.trim(),
                username: tgSession.username || null,
                balance: 0,
                createdAt: serverTimestamp(),
                isPremium: false,
                premiumTier: 'plan0',
                premiumExpiry: null,
                lastNotificationCheck: null,
                dailyCompletedTasks: [],
                referredBy: null
            };
            await setDoc(userRef, userData);
        }

        if(userData.isBlocked) {
            document.body.innerHTML = '<div class="flex items-center justify-center h-screen text-red-500 font-bold">ACCOUNT SUSPENDED</div>';
            throw new Error("User account is blocked.");
        }
        
        updateDashboard();
        initRealtimeListeners();
        checkNewNotifications();
        checkFreeTrialExpiry();
    }

    async function loadConfig() {
        try {
            const configRef = doc(db, "config", "main");
            const configSnap = await getDoc(configRef);
            if (configSnap.exists()) {
                const configData = configSnap.data();
                sysConfig = configData;

                MIN_DEPOSIT_AMT = sysConfig.minDeposit || 10;
                MIN_WITHDRAWAL_AMT = sysConfig.minWithdrawal || 5;
                MIN_REFERRALS_FOR_WITHDRAWAL = sysConfig.minReferralsForWithdrawal || 2;
                REFERRAL_BONUS = sysConfig.referralBonus || 1;
                TASK_REWARD = sysConfig.taskReward || 0.5;

                document.getElementById('min-deposit-text').textContent = `$${MIN_DEPOSIT_AMT.toFixed(2)}`;
                document.getElementById('min-withdrawal-text').textContent = `$${MIN_WITHDRAWAL_AMT.toFixed(2)}`;
                const withdrawalInfoText = `Withdrawals are processed within 24 hours. Minimum withdrawal is <span class="text-white font-bold">$${MIN_WITHDRAWAL_AMT.toFixed(2)}</span>. You need at least <span class="text-white font-bold">${MIN_REFERRALS_FOR_WITHDRAWAL}</span> referrals to withdraw.`;
                document.getElementById('withdrawal-info-text').innerHTML = withdrawalInfoText;
                
                if(configData.premiumTiers) {
                     Object.keys(premiumTiers).forEach(key => {
                        if(configData.premiumTiers[key]) {
                            const remoteTier = configData.premiumTiers[key];
                            premiumTiers[key].price = remoteTier.price !== undefined ? remoteTier.price : premiumTiers[key].price;
                            premiumTiers[key].duration = remoteTier.duration !== undefined ? remoteTier.duration : premiumTiers[key].duration;
                            premiumTiers[key].taskLimit = remoteTier.taskLimit !== undefined ? remoteTier.taskLimit : premiumTiers[key].taskLimit;
                            if(remoteTier.benefits) {
                                premiumTiers[key].benefits = {...premiumTiers[key].benefits, ...remoteTier.benefits};
                            }
                        }
                    });
                }
            }
        } catch (error) {
            console.error("Could not load remote config, using defaults.", error);
        }
    }

    function updateDashboard() {
        if(!userData) return;
        const bal = userData.balance.toFixed(2);
        document.getElementById('main-balance-display').textContent = `$${bal}`;
        document.getElementById('user-balance-top').textContent = `$${bal}`;

        const initials = (tgSession.first_name?.[0] || 'U') + (tgSession.last_name?.[0] || '');
        document.getElementById('nav-user-initials').textContent = initials.toUpperCase();
        document.getElementById('profile-user-initials').textContent = initials.toUpperCase();

        if(tgSession.photo_url) {
            document.getElementById('nav-user-img').src = tgSession.photo_url;
            document.getElementById('nav-user-img').classList.remove('hidden');
            document.getElementById('nav-user-initials').classList.add('hidden');
             document.getElementById('profile-user-img').src = tgSession.photo_url;
            document.getElementById('profile-user-img').classList.remove('hidden');
            document.getElementById('profile-user-initials').classList.add('hidden');
        }

        const profileNameEl = document.getElementById('profile-name-display');
        const isPremiumExpired = userData.premiumExpiry && userData.premiumExpiry.toDate() < new Date();
        
        if (userData.isPremium && userData.premiumTier !== 'plan0' && !isPremiumExpired) {
             profileNameEl.innerHTML = `
                <span>${userData.name}</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor">
                  <path fill-rule="evenodd" d="M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12c0 1.357-.6 2.573-1.549 3.397a4.49 4.49 0 01-1.307 3.497 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.491 4.491 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" style="color: #3b82f6;"></path>
                </svg>`;
        } else {
            if(userData.isPremium && isPremiumExpired){
                updateDoc(doc(db, "users", userData.tgChatId), { isPremium: false, premiumTier: 'plan0', premiumExpiry: null });
            }
            profileNameEl.innerHTML = `<span>${userData.name}</span>`;
        }

        document.getElementById('uid-display').textContent = userData.tgChatId;
    }
    
    function checkFreeTrialExpiry() {
        if (!userData || !userData.createdAt || userData.premiumTier !== 'plan0' || !(userData.createdAt.toDate)) {
            return;
        }

        const accountCreationDate = userData.createdAt.toDate();
        const trialEndDate = new Date(accountCreationDate);
        const trialDurationDays = premiumTiers.plan0.duration;
        trialEndDate.setDate(trialEndDate.getDate() + trialDurationDays);

        if (new Date() > trialEndDate) {
            const modalHTML = `
                <div class="text-center space-y-4">
                    <i data-lucide="clock" class="w-12 h-12 mx-auto text-yellow-400"></i>
                    <h3 class="text-xl font-bold">Free Trial Ended</h3>
                    <p class="text-slate-300">Your ${trialDurationDays}-day free trial has expired. Please upgrade to a premium plan to continue earning rewards.</p>
                    <button onclick="switchView('view-premium'); closeModal();" class="action-btn w-full py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500">View Plans</button>
                </div>
            `;
            showModal(modalHTML, false); 
        }
    }

    window.switchView = function(viewId) {
        activeTimers.forEach(timerId => clearInterval(timerId));
        activeTimers = [];

        document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active-view'));
        document.getElementById(viewId).classList.add('active-view');

        const mainViews = ['view-dashboard', 'view-tasks', 'view-refer', 'view-news', 'view-profile'];
        if (mainViews.includes(viewId)) {
            document.querySelectorAll('.dock-item').forEach(btn => {
                btn.classList.toggle('nav-active', btn.dataset.target === viewId);
            });
        }
        
        const topDepositBtn = document.querySelector('header .flex.items-center.gap-2 > button:first-child');
        if (topDepositBtn) {
           topDepositBtn.style.display = (viewId === 'view-deposit' || viewId === 'view-withdrawal') ? 'none' : 'inline-flex';
        }

        if(viewId === 'view-tasks') loadTasksView();
        if(viewId === 'view-deposit') loadDepositHistory();
        if(viewId === 'view-withdrawal') loadWithdrawalHistory();
        if(viewId === 'view-profile') loadProfileStats();
        if(viewId === 'view-news') loadNewsFeed();
        if(viewId === 'view-premium') loadPremiumTiers();
        if(viewId === 'view-features') loadActivityLog();
        if(viewId === 'view-refer') loadReferralView();

        window.scrollTo(0,0);
    }
    
    function loadPremiumTiers() {
        const container = document.getElementById('premium-tiers-container');
        const tierKeys = Object.keys(premiumTiers).sort((a,b) => premiumTiers[a].level - premiumTiers[b].level);
        const isPremiumExpired = userData.premiumExpiry && userData.premiumExpiry.toDate() < new Date();
        const currentUserLevel = (userData.isPremium && !isPremiumExpired) ? premiumTiers[userData.premiumTier]?.level || 0 : 0;
        
        let html = tierKeys.map(key => {
            const tier = premiumTiers[key];
            if (tier.level === 0) return '';
            
            let benefitsList = [];
            for (const bKey in tier.benefits) {
                if (bKey.startsWith('benefit_text_')) {
                    benefitsList.push(`<li><i class="inline-block w-4 h-4" data-lucide="check"></i> ${tier.benefits[bKey]}</li>`);
                }
            }
            if (tier.benefits.feeReduction > 0) {
                 const reducedFee = (P2P_FEE_PERCENT - tier.benefits.feeReduction) * 100;
                 benefitsList.push(`<li><i class="inline-block w-4 h-4" data-lucide="check"></i> P2P Fee reduced to <strong>${reducedFee.toFixed(0)}%</strong></li>`);
            }
            
            let buttonHtml;
            const isCurrentPlan = tier.level === currentUserLevel && !isPremiumExpired;
            
            if (isCurrentPlan) {
                buttonHtml = `<div class="text-center font-semibold text-lg text-green-400 py-3">CURRENT PLAN</div>`;
                if(userData.premiumExpiry) {
                    const expiryElId = `countdown-${key}`;
                    buttonHtml += `<div id="${expiryElId}" class="text-center font-mono text-sm text-cyan-400 pb-3"></div>`;
                    const countdownInterval = setInterval(() => {
                        const now = new Date().getTime();
                        const expiryTime = userData.premiumExpiry.toDate().getTime();
                        const distance = expiryTime - now;

                        if (distance < 0) {
                            clearInterval(countdownInterval);
                            document.getElementById(expiryElId).innerHTML = "EXPIRED";
                            return;
                        }

                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        
                        document.getElementById(expiryElId).innerHTML = `Expires in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
                    }, 1000);
                    activeTimers.push(countdownInterval);
                }
            } else if (tier.level < currentUserLevel && !isPremiumExpired) {
                buttonHtml = `<button class="action-btn w-full py-3 rounded-xl" disabled>Activated</button>`;
            } else {
                buttonHtml = `<button onclick="purchasePremium('${key}')" class="action-btn w-full py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500">UPGRADE</button>`;
            }

            return `
            <div class="neo-card p-5 rounded-2xl ${isCurrentPlan ? 'border-yellow-400/50' : 'border-slate-700'}">
                <h3 class="text-2xl font-bold text-yellow-400">${tier.name}</h3>
                <p class="text-3xl font-bold my-3">$${tier.price} <span class="text-lg text-slate-400">/ ${tier.duration} days</span></p>
                <ul class="text-sm text-slate-300 space-y-2 my-4 text-left pl-2">
                    ${benefitsList.join('')}
                </ul>
                ${buttonHtml}
            </div>`;
        }).join('');
        container.innerHTML = html;
        lucide.createIcons();
    }

    window.purchasePremium = async function(tierKey) {
        const tier = premiumTiers[tierKey];
        if (userData.balance < tier.price) {
            return showToast(`Insufficient balance. You need $${tier.price}.`, 'error');
        }

        showModal(`
            <div class="text-center space-y-4">
                <h3 class="text-xl font-bold">Confirm Purchase</h3>
                <p>Are you sure you want to buy the ${tier.name} plan for $${tier.price} (${tier.duration} days)?</p>
                <button id="confirm-premium-purchase" class="action-btn w-full py-3 rounded-xl">Confirm</button>
                <button onclick="closeModal()" class="neo-card w-full py-2 rounded-xl mt-2">Cancel</button>
            </div>
        `);

        document.getElementById('confirm-premium-purchase').onclick = async function() {
            this.disabled = true; this.textContent = "PROCESSING...";
            try {
                const userRef = doc(db, "users", userData.tgChatId);
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists() || userDoc.data().balance < tier.price) {
                        throw "Transaction failed: Insufficient funds.";
                    }
                    
                    const newBalance = userDoc.data().balance - tier.price;
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + tier.duration);
                    
                    transaction.update(userRef, {
                        balance: newBalance,
                        isPremium: true,
                        premiumTier: tierKey,
                        premiumExpiry: Timestamp.fromDate(expiryDate)
                    });
                });
                
                logPublicActivity(`upgraded to ${tier.name} Premium!`);
                closeModal();
                showToast(`Successfully upgraded to ${tier.name}!`, 'success');
                
                userData.balance -= tier.price;
                userData.isPremium = true;
                userData.premiumTier = tierKey;
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + tier.duration);
                userData.premiumExpiry = Timestamp.fromDate(expiryDate);

                updateDashboard();
                loadPremiumTiers();

            } catch (error) {
                closeModal();
                showToast(error.toString(), 'error');
            }
        };
    }

    function loadTasksView() {
        if (userData.premiumTier === 'plan0' && userData.createdAt && userData.createdAt.toDate) {
            const accountCreationDate = userData.createdAt.toDate();
            const trialEndDate = new Date(accountCreationDate);
            trialEndDate.setDate(trialEndDate.getDate() + premiumTiers.plan0.duration);
            if (new Date() > trialEndDate) {
                checkFreeTrialExpiry();
                document.getElementById('task-list').innerHTML = '';
                return;
            }
        }
        
        const taskListContainer = document.getElementById('task-list');
        window.startTask = startTask;

        const taskReward = TASK_REWARD;
        const taskLink = sysConfig.taskLink || "https://adexora.my.id/dl/AqMmpgSA5cUt";
        
        let taskLimit = premiumTiers.plan0.taskLimit;
        const isPremiumExpired = userData.premiumExpiry && userData.premiumExpiry.toDate() < new Date();
        
        if (userData.isPremium && userData.premiumTier && !isPremiumExpired) {
            taskLimit = premiumTiers[userData.premiumTier]?.taskLimit || taskLimit;
        }

        const today = new Date().toISOString().split('T')[0];
        const completedToday = (userData.dailyCompletedTasks || [])
            .filter(task => task.completedAt && new Date(task.completedAt.seconds * 1000).toISOString().split('T')[0] === today)
            .map(task => task.taskId);
        
        let firstPendingTask = null;
        
        for (let i = 1; i <= taskLimit; i++) {
            const taskId = `daily_task_${i}`;
            if (!completedToday.includes(taskId)) {
                firstPendingTask = { id: taskId, title: `Task ${i}`, reward: taskReward, link: taskLink };
                break;
            }
        }

        let tasksHTML = Array.from({ length: taskLimit }, (_, i) => {
            const taskId = `daily_task_${i + 1}`;
            const isCompleted = completedToday.includes(taskId);
            const task = { id: taskId, title: `Task ${i + 1}`, reward: taskReward, link: taskLink };
            const isFirstPending = firstPendingTask && task.id === firstPendingTask.id;

            let buttonHTML;
            if (isCompleted) {
                buttonHTML = `<button class="bg-emerald-500 text-white px-5 py-2 rounded-lg font-semibold text-sm cursor-not-allowed">Completed</button>`;
            } else if (isFirstPending) {
                buttonHTML = `<button onclick='startTask(${JSON.stringify(task)}, this)' class="task-update-btn animated-task-button px-5 py-2 rounded-lg text-sm">UPDATE</button>`;
            } else {
                buttonHTML = `<button class="bg-slate-600 text-slate-300 px-5 py-2 rounded-lg font-semibold text-sm cursor-not-allowed">Locked</button>`;
            }

            return `
                <div class="flex items-center justify-between bg-slate-800 p-3 rounded-xl border border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-500/20 p-3 rounded-full">
                             <i data-lucide="arrow-up-right-square" class="w-6 h-6 text-indigo-400"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-md text-slate-200">${task.title}</h3>
                            <p class="text-yellow-400 font-bold text-sm">Reward: $${task.reward.toFixed(2)}</p>
                        </div>
                    </div>
                    ${buttonHTML}
                </div>
            `;
        }).join('');
        
        taskListContainer.innerHTML = tasksHTML;
        
        if (completedToday.length >= taskLimit) {
            const newTasksCardHTML = `
                <div class="flex items-center justify-between bg-slate-800 p-3 rounded-xl border border-slate-700 mt-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-500/20 p-3 rounded-full">
                             <i data-lucide="arrow-up-right-square" class="w-6 h-6 text-indigo-400"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-md text-slate-200">Tasks Reset In</h3>
                            <p id="new-task-countdown" class="text-cyan-400 font-bold text-sm font-mono">--:--:--</p>
                        </div>
                    </div>
                    <button onclick="switchView('view-premium')" class="task-update-btn px-5 py-2 rounded-lg text-sm">GET MORE</button>
                </div>`;
            taskListContainer.innerHTML += newTasksCardHTML;
            startTaskCountdown();
        }

        lucide.createIcons();
    }
    
    function startTaskCountdown() {
        const timerElement = document.getElementById('new-task-countdown');
        if (!timerElement) return;

        const countdownInterval = setInterval(() => {
            const now = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(now.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            const diff = tomorrow.getTime() - now.getTime();
            if (diff <= 0) {
                clearInterval(countdownInterval);
                timerElement.textContent = "00:00:00";
                loadTasksView();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);
        activeTimers.push(countdownInterval);
    }
    
    function startTask(task, buttonElement) {
        buttonElement.disabled = true;
        window.open(task.link, '_blank');

        let countdown = 10;
        buttonElement.textContent = `Waiting (${countdown}s)`;
        const intervalId = setInterval(() => {
            countdown--;
            buttonElement.textContent = `Waiting (${countdown}s)`;
            if (countdown <= 0) {
                clearInterval(intervalId);
                completeTask(task);
            }
        }, 1000);
        activeTimers.push(intervalId);
    }
    
    async function completeTask(task) {
        if (!task) return;

        const today = new Date().toISOString().split('T')[0];
        const alreadyCompleted = (userData.dailyCompletedTasks || [])
            .some(t => t.taskId === task.id && t.completedAt && new Date(t.completedAt.seconds * 1000).toISOString().split('T')[0] === today);

        if (alreadyCompleted) {
            showToast(`This task has already been completed today.`, 'info');
            return;
        }

        try {
            const userRef = doc(db, "users", userData.tgChatId);
            await runTransaction(db, async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists()) throw "User not found.";

                const currentData = userDoc.data();
                const newBalance = currentData.balance + task.reward;
                const newTaskEntry = { taskId: task.id, completedAt: Timestamp.fromDate(new Date()) };
                
                const existingTasks = Array.isArray(currentData.dailyCompletedTasks) ? currentData.dailyCompletedTasks : [];
                const updatedCompletedTasks = [...existingTasks, newTaskEntry];

                transaction.update(userRef, {
                    balance: newBalance,
                    dailyCompletedTasks: updatedCompletedTasks
                });
            });
            showToast(`Congratulations! You've earned $${task.reward.toFixed(2)}`, 'success');
            logPublicActivity(`earned $${task.reward.toFixed(2)} from a task.`);
        } catch (e) {
            console.error("Error completing task:", e);
            showToast(`Error: ${e.message || e}`, 'error');
            if (document.getElementById('view-tasks').classList.contains('active-view')) {
                loadTasksView();
            }
        }
    }

    document.getElementById('btn-submit-deposit').addEventListener('click', async () => {
        const method = document.getElementById('dep-method').value;
        const amount = parseFloat(document.getElementById('dep-amount').value);
        const sender = document.getElementById('dep-sender').value.trim();

        if(!method || !amount || !sender) return showToast("Please fill all fields", "warning");
        if(amount < MIN_DEPOSIT_AMT) return showModal(`<div class="text-center text-red-400 space-y-3"><i data-lucide="alert-octagon" class="w-12 h-12 mx-auto"></i><h3 class="font-bold text-lg">Invalid Amount</h3><p class="text-slate-300">Minimum deposit amount is <span class="font-bold text-white">$${MIN_DEPOSIT_AMT.toFixed(2)}</span>.</p><button onclick="closeModal()" class="neo-card w-full py-2 rounded-xl mt-4">OK</button></div>`);

        const btn = document.getElementById('btn-submit-deposit');
        btn.disabled = true; btn.innerText = "VERIFYING...";

        try {
            await addDoc(collection(db, "deposits"), {
                userId: userData.tgChatId,
                firebaseUid: userData.firebaseUid,
                userName: userData.name, 
                method, 
                amount, 
                senderNumber: sender,
                status: "pending", 
                requestedAt: serverTimestamp()
            });
            
            showModal(`<div class="text-center space-y-3"><i data-lucide="check-circle" class="w-12 h-12 text-emerald-500 mx-auto"></i><h3 class="text-lg font-bold text-white">Submitted!</h3><p class="text-slate-400">Your deposit of $${amount} is under review. It typically takes 5-30 minutes.</p><button onclick="closeModal()" class="action-btn w-full py-2 rounded-xl">OK</button></div>`);
            
            document.getElementById('dep-method').value = '';
            document.getElementById('dep-method-text').textContent = 'Select Payment Method';
            document.getElementById('dep-method-selector').classList.add('text-slate-400');
            document.getElementById('dep-amount').value = '';
            document.getElementById('dep-sender').value = '';
            loadDepositHistory();

        } catch(e) { showToast(e.message, "error");
        } finally {
            btn.disabled = false; btn.innerText = "VERIFY DEPOSIT"; lucide.createIcons();
        }
    });

    async function loadDepositHistory() {
        const el = document.getElementById('deposit-history-log');
        const q = query(collection(db, "deposits"), where("userId", "==", userData.tgChatId), orderBy("requestedAt", "desc"), limit(10));
        const snap = await getDocs(q);

        if(snap.empty) { el.innerHTML = '<p class="text-slate-600 text-center text-xs py-2">No deposit history.</p>'; return; }

        el.innerHTML = snap.docs.map(d => {
            const data = d.data();
            const statusColors = { pending: 'text-yellow-500', approved: 'text-emerald-500', rejected: 'text-red-500' };
            const date = data.requestedAt ? new Date(data.requestedAt.seconds * 1000).toLocaleDateString() : 'N/A';
            return `
            <div class="flex justify-between items-center p-3 bg-slate-800/40 rounded-xl border border-slate-800">
                <div>
                    <p class="text-sm font-medium text-slate-300">${data.method} - $${data.amount}</p>
                    <p class="text-[10px] text-slate-500 font-mono">${date}</p>
                </div>
                <span class="text-xs font-bold ${statusColors[data.status] || 'text-slate-400'} uppercase">${data.status}</span>
            </div>`;
        }).join('');
    }
    
    document.getElementById('btn-submit-withdrawal').addEventListener('click', async () => {
        const method = document.getElementById('wd-method').value;
        const address = document.getElementById('wd-address').value.trim();
        const amount = parseFloat(document.getElementById('wd-amount').value);
        
        const btn = document.getElementById('btn-submit-withdrawal');
        btn.disabled = true; btn.innerText = "PROCESSING...";

        try {
            const referralsQuery = query(collection(db, "users"), where("referredBy", "==", userData.tgChatId));
            const referralsSnap = await getDocs(referralsQuery);
            if (referralsSnap.size < MIN_REFERRALS_FOR_WITHDRAWAL) {
                throw new Error(`You need at least ${MIN_REFERRALS_FOR_WITHDRAWAL} referrals to make a withdrawal.`);
            }

            if (!method || !address || isNaN(amount)) throw new Error("Please fill all fields correctly.");
            if (amount < MIN_WITHDRAWAL_AMT) throw new Error(`Minimum withdrawal is $${MIN_WITHDRAWAL_AMT.toFixed(2)}.`);
            if (userData.balance < amount) throw new Error("Insufficient balance.");

            const userRef = doc(db, "users", userData.tgChatId);

            await runTransaction(db, async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists() || userDoc.data().balance < amount) {
                    throw new Error("Transaction failed: Insufficient funds.");
                }

                const newBalance = userDoc.data().balance - amount;
                transaction.update(userRef, { balance: newBalance });

                const withdrawalRef = doc(collection(db, "withdrawals"));
                transaction.set(withdrawalRef, {
                    userId: userData.tgChatId,
                    firebaseUid: userData.firebaseUid,
                    userName: userData.name,
                    method,
                    address,
                    amount,
                    status: "pending",
                    requestedAt: serverTimestamp()
                });
            });

            showModal(`<div class="text-center space-y-3"><i data-lucide="check-circle" class="w-12 h-12 text-emerald-500 mx-auto"></i><h3 class="text-lg font-bold text-white">Withdrawal Submitted!</h3><p class="text-slate-400">Your withdrawal request for $${amount} has been received and will be processed within 24 hours.</p><button onclick="closeModal()" class="action-btn w-full py-2 rounded-xl">OK</button></div>`);
            
            document.getElementById('wd-method').value = '';
            document.getElementById('wd-method-text').textContent = 'Select Withdrawal Method';
            document.getElementById('wd-method-selector').classList.add('text-slate-400');
            document.getElementById('wd-address').value = '';
            document.getElementById('wd-amount').value = '';
            loadWithdrawalHistory();

        } catch(e) {
            showToast(e.message, "error");
        } finally {
            btn.disabled = false; btn.innerText = "SUBMIT WITHDRAWAL";
            lucide.createIcons();
        }
    });

    async function loadWithdrawalHistory() {
        const el = document.getElementById('withdrawal-history-log');
        el.innerHTML = '<p class="text-slate-600 text-center text-xs py-2">Loading history...</p>';
        const q = query(collection(db, "withdrawals"), where("userId", "==", userData.tgChatId), orderBy("requestedAt", "desc"), limit(10));
        const snap = await getDocs(q);

        if(snap.empty) { el.innerHTML = '<p class="text-slate-600 text-center text-xs py-2">No withdrawal history.</p>'; return; }

        el.innerHTML = snap.docs.map(d => {
            const data = d.data();
            const statusColors = { pending: 'text-yellow-500', approved: 'text-emerald-500', rejected: 'text-red-500' };
            return `
            <div class="flex justify-between items-center p-3 bg-slate-800/40 rounded-xl border border-slate-800">
                <div>
                    <p class="text-sm font-medium text-slate-300">${data.method} - $${data.amount}</p>
                    <p class="text-[10px] text-slate-500 font-mono">${data.address}</p>
                </div>
                <span class="text-xs font-bold ${statusColors[data.status] || 'text-slate-400'} uppercase">${data.status}</span>
            </div>`;
        }).join('');
    }

    async function initLiveWithdrawalFeed() {
        const container = document.getElementById('withdrawal-feed-container');
        if (!container) return;

        let allActivities = [];

        try {
            const fakeQ = query(collection(db, "fake_deposits"), limit(20));
            const fakeSnap = await getDocs(fakeQ);
            fakeSnap.forEach(doc => {
                allActivities.push({ ...doc.data(), isFake: true });
            });

            const realQ = query(collection(db, "withdrawals"), where("status", "==", "approved"), orderBy("requestedAt", "desc"), limit(10));
            const realSnap = await getDocs(realQ);
            realSnap.forEach(doc => {
                const data = doc.data();
                allActivities.push({ name: data.userName, amount: data.amount, isFake: false });
            });

            allActivities.sort(() => 0.5 - Math.random());

            if (allActivities.length === 0) {
                 container.innerHTML = '<p class="text-center text-slate-600 text-sm p-4">No recent activity.</p>';
                 return;
            }
            
            let currentIndex = 0;
            function showNextActivity() {
                if (allActivities.length === 0) return;
                const activity = allActivities[currentIndex];
                const name = activity.name.substring(0, 3) + '***';
                const timeAgo = Math.floor(Math.random() * 59) + 1;

                const item = document.createElement('div');
                item.className = 'neo-card p-3 rounded-xl flex items-center gap-3 animate-fade-in-down';
                item.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center">
                        <i data-lucide="arrow-up-right" class="w-5 h-5 text-cyan-400"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-200">
                            ${name} just withdrew <span class="text-cyan-400">$${activity.amount}</span>
                        </p>
                        <p class="text-xs text-slate-500">${timeAgo} seconds ago</p>
                    </div>`;
                
                container.prepend(item);
                lucide.createIcons();

                if (container.children.length > 10) {
                    container.lastChild.remove();
                }

                currentIndex = (currentIndex + 1) % allActivities.length;
            }

            showNextActivity();
            const feedInterval = setInterval(showNextActivity, Math.random() * (8000 - 4000) + 4000);
            activeTimers.push(feedInterval);

        } catch (e) {
            console.error("Failed to load activity feed:", e);
            container.innerHTML = '<p class="text-center text-red-500 text-sm">Could not load feed.</p>';
        }
    }
    
    async function loadReferralView() {
        const linkInput = document.getElementById('referral-link-display');
        const refCountEl = document.getElementById('ref-stat-count');
        const refEarningsEl = document.getElementById('ref-stat-earnings');
        
        document.getElementById('referral-bonus-text').textContent = `$${REFERRAL_BONUS.toFixed(2)}`;
        document.getElementById('referral-claim-bonus-text').textContent = `$${REFERRAL_BONUS.toFixed(2)}`;
        
        const referralLink = `https://t.me/Reward_Claimlbot/eaen?start=${userData.tgChatId}`;
        linkInput.value = referralLink;
        
        const inputSection = document.getElementById('referral-input-section');
        if (userData.referredBy) {
            const referrerRef = doc(db, "users", userData.referredBy);
            const referrerSnap = await getDoc(referrerRef);
            let referrerName = `UID: ${userData.referredBy}`;
            if(referrerSnap.exists()){
                referrerName = referrerSnap.data().name || `UID: ${userData.referredBy}`;
            }

            inputSection.innerHTML = `
                <h3 class="font-semibold text-slate-200 text-lg flex items-center justify-center gap-2"><i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>Referral Claimed</h3>
                <p class="text-sm text-slate-400">You were referred by: <span class="font-semibold text-white">${referrerName}</span></p>
            `;
            lucide.createIcons();
        }
        
        initLiveReferralFeed();

        async function getReferralStats() {
            try {
                const q = query(collection(db, "users"), where("referredBy", "==", userData.tgChatId));
                const snap = await getDocs(q);
                
                refCountEl.textContent = snap.docs.length;
                const referralEarnings = snap.docs.length * REFERRAL_BONUS; 
                refEarningsEl.textContent = `$${referralEarnings.toFixed(2)}`;
                
            } catch (error) {
                console.error("Error loading referral data:", error);
            }
        }
        
        getReferralStats();
    }

    async function verifyReferralCode() {
        const btn = document.getElementById('btn-verify-referral');
        const input = document.getElementById('referral-code-input');
        const code = input.value.trim();
        const rewardAmount = REFERRAL_BONUS;

        if (!code) return showToast("Please enter a referral code.", "warning");
        if (userData.referredBy) return showToast("You have already used a referral code.", "error");
        if (code === userData.tgChatId) return showToast("You cannot refer yourself.", "error");

        btn.disabled = true;
        btn.innerHTML = 'VERIFYING...';

        try {
            await runTransaction(db, async (transaction) => {
                const currentUserRef = doc(db, "users", userData.tgChatId);
                const referrerRef = doc(db, "users", code);

                const [currentUserDoc, referrerDoc] = await Promise.all([
                    transaction.get(currentUserRef),
                    transaction.get(referrerRef)
                ]);

                if (!currentUserDoc.exists()) throw new Error("Your user data could not be found.");
                if (!referrerDoc.exists()) throw new Error("The referral code is invalid or the user does not exist.");

                const currentUserData = currentUserDoc.data();
                if (currentUserData.referredBy) throw new Error("You have already claimed a referral bonus.");

                transaction.update(currentUserRef, {
                    balance: currentUserData.balance + rewardAmount,
                    referredBy: code
                });

                transaction.update(referrerRef, {
                    balance: referrerDoc.data().balance + rewardAmount
                });

                const logRef = doc(collection(db, "referral_logs"));
                transaction.set(logRef, {
                    referrerId: code,
                    referrerName: referrerDoc.data().name || 'A user',
                    refereeId: userData.tgChatId,
                    refereeName: userData.name,
                    reward: rewardAmount,
                    timestamp: serverTimestamp()
                });
            });

            showToast(`Success! You and your friend both earned $${rewardAmount.toFixed(2)}.`, 'success');
            userData.balance += rewardAmount;
            userData.referredBy = code;
            updateDashboard();
            loadReferralView(); 

        } catch (e) {
            showToast("Error: " + e.message, "error");
            btn.disabled = false;
            btn.innerHTML = `VERIFY & CLAIM <span id="referral-claim-bonus-text">$${REFERRAL_BONUS.toFixed(2)}</span>`;
        }
    }
    
    async function initLiveReferralFeed() {
        const container = document.getElementById('referral-feed-container');
        if (!container) return;

        try {
            const q = query(collection(db, "referral_logs"), orderBy("timestamp", "desc"), limit(20));
            const snap = await getDocs(q);

            let allActivities = [];
            snap.forEach(doc => allActivities.push(doc.data()));

            if (allActivities.length === 0) {
                 container.innerHTML = '<p class="text-center text-slate-600 text-sm p-4">Be the first to refer a friend!</p>';
                 return;
            }

            let currentIndex = 0;
            const showNextActivity = () => {
                if (allActivities.length === 0) return;
                const activity = allActivities[currentIndex];
                const refereeName = (activity.refereeName || 'Someone').substring(0, 3) + '***';
                const referrerName = (activity.referrerName || 'A user').substring(0, 3) + '***';
                const timeAgo = Math.floor(Math.random() * 59) + 1;

                const item = document.createElement('div');
                item.className = 'neo-card p-3 rounded-xl flex items-center gap-3 animate-fade-in-down';
                item.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center">
                        <i data-lucide="award" class="w-5 h-5 text-emerald-400"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-200">
                           ${refereeName} was invited by ${referrerName}!
                        </p>
                        <p class="text-xs text-slate-500">Both earned $${activity.reward.toFixed(2)} - ${timeAgo}s ago</p>
                    </div>`;

                container.prepend(item);
                lucide.createIcons();

                if (container.children.length > 10) {
                    container.lastChild.remove();
                }
                currentIndex = (currentIndex + 1) % allActivities.length;
            };

            showNextActivity();
            const feedInterval = setInterval(showNextActivity, Math.random() * (9000 - 5000) + 5000);
            activeTimers.push(feedInterval);

        } catch (e) {
            console.error("Failed to load referral feed:", e);
            container.innerHTML = '<p class="text-center text-red-500 text-sm">Could not load feed.</p>';
        }
    }

    window.shareOnTelegram = function() {
        const link = document.getElementById('referral-link-display').value;
        const text = "Join me on REWARD CLAIM and earn money! Use my link to sign up:";
        const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
        window.open(telegramUrl, '_blank');
    }

    window.shareLive = async function() {
        const link = document.getElementById('referral-link-display').value;
        const shareData = {
            title: 'Join REWARD CLAIM',
            text: 'Join me on REWARD CLAIM and earn money! Use my link to sign up:',
            url: link,
        };
        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                throw new Error('Web Share API not supported');
            }
        } catch (err) {
            copyText(link);
            showToast('Share not supported, link copied instead!', 'info');
        }
    }

    async function checkNewNotifications() {
        const lastCheck = userData.lastNotificationCheck || Timestamp.fromDate(new Date(0));
        const q = query(
            collection(db, "notifications"), 
            where("userId", "==", userData.tgChatId),
            where("createdAt", ">", lastCheck), 
            limit(1)
        );
        const snap = await getDocs(q);
        if (!snap.empty) {
            document.getElementById('badge-notify').classList.remove('hidden');
        }
    }

    async function loadNotifications() {
        const q = query(
            collection(db, "notifications"), 
            where("userId", "==", userData.tgChatId),
            orderBy("createdAt", "desc"), 
            limit(10)
        );
        const snap = await getDocs(q);

        let content = `<h3 class="text-lg font-bold text-white mb-4">Notifications</h3><div class="space-y-3 max-h-80 overflow-y-auto">`;
        if (snap.empty) {
            content += `<p class="text-slate-500 text-center">No new notifications.</p>`;
        } else {
            content += snap.docs.map(doc => {
                const n = doc.data();
                const date = n.createdAt.toDate().toLocaleString();
                return `<div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                            <p class="font-semibold text-slate-200">${n.title}</p>
                            <p class="text-sm text-slate-400">${n.message}</p>
                            <p class="text-xs text-slate-600 text-right mt-2">${date}</p>
                       </div>`;
            }).join('');
        }
        content += `</div>`;
        showModal(content);
        lucide.createIcons();

        document.getElementById('badge-notify').classList.add('hidden');
        await updateDoc(doc(db, "users", userData.tgChatId), {
            lastNotificationCheck: serverTimestamp()
        });
    }
    
    async function logPublicActivity(actionText) {
        try {
            await addDoc(collection(db, "public_activity"), {
                userId: userData.tgChatId,
                userName: userData.name,
                userPhoto: tgSession.photo_url || null,
                action: actionText,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Failed to log public activity:", e);
        }
    }

    window.openPremiumPage = () => { closeSidePanel(); switchView('view-premium'); };
    window.openSupport = () => { 
        const supportLink = sysConfig.supportLink || "https://t.me/sarahmartinBTC";
        window.open(supportLink, '_blank'); 
    };
    window.visitWebsite = () => {
        const websiteUrl = sysConfig.websiteUrl || "#";
        window.open(websiteUrl, '_blank');
    };
    window.closeSidePanel = () => {
        document.getElementById('main-side-panel').classList.remove('open');
        document.getElementById('panel-overlay').classList.remove('open');
    };
    
    window.showModal = (html, showCloseButton = true) => {
        const modal = document.getElementById('nexus-modal');
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-close').style.display = showCloseButton ? 'block' : 'none';
        modal.style.pointerEvents = 'auto'; modal.style.opacity = '1';
        document.getElementById('modal-content').classList.remove('scale-95');
        document.getElementById('modal-content').classList.add('scale-100');
        lucide.createIcons();
    };

    window.closeModal = () => {
         const modal = document.getElementById('nexus-modal');
         modal.style.opacity = '0'; modal.style.pointerEvents = 'none';
         document.getElementById('modal-content').classList.add('scale-95');
         document.getElementById('modal-content').classList.remove('scale-100');
    };
    window.showToast = (msg, type='info') => {
         if(window.Telegram?.WebApp?.showPopup) { window.Telegram.WebApp.showAlert(msg); }
         else { alert(msg); }
    };
    window.copyText = (text) => { navigator.clipboard.writeText(text); showToast("Copied to clipboard!"); };
    window.copyNumber = (num, name) => { copyText(num); showToast(`${name} address copied!`); };
    
    function showMethodSelector(targetInputId, targetTextId, title, options) {
        let optionsHTML = options.map(opt =>
            `<button data-value="${opt.value}" class="select-option-btn neo-card w-full p-3 rounded-lg text-left hover:bg-slate-700 transition">${opt.text}</button>`
        ).join('');

        const modalHTML = `
            <div class="space-y-2">
                <h3 class="text-lg font-bold text-center mb-4">${title}</h3>
                ${optionsHTML}
            </div>
        `;
        showModal(modalHTML);

        document.querySelectorAll('.select-option-btn').forEach(btn => {
            btn.onclick = () => {
                const selectedValue = btn.dataset.value;
                const selectedText = btn.textContent;
                document.getElementById(targetInputId).value = selectedValue;
                const textEl = document.getElementById(targetTextId);
                textEl.textContent = selectedText;
                textEl.parentElement.classList.remove('text-slate-400');
                textEl.parentElement.classList.add('text-white');
                closeModal();
            };
        });
    }

    async function executeP2PTransfer() {
        const recipientUid = document.getElementById('p2p-uid').value.trim();
        const amount = parseFloat(document.getElementById('p2p-amount').value);
        const btn = document.getElementById('btn-exec-p2p');

        if (!recipientUid || !amount) return showToast("Please enter UID and amount.", "warning");
        if (recipientUid === userData.tgChatId) return showToast("You cannot transfer to yourself.", "error");
        if (amount < MIN_P2P_AMT) return showToast(`Minimum transfer amount is $${MIN_P2P_AMT.toFixed(2)}.`, "warning");
        
        let feePercent = P2P_FEE_PERCENT;
        const isPremiumExpired = userData.premiumExpiry && userData.premiumExpiry.toDate() < new Date();
        if (userData.isPremium && !isPremiumExpired && premiumTiers[userData.premiumTier]?.benefits.feeReduction > 0) {
            feePercent -= premiumTiers[userData.premiumTier].benefits.feeReduction;
        }
        const fee = amount * feePercent;
        const totalCost = amount + fee;

        if (userData.balance < totalCost) return showToast(`Insufficient balance. You need $${totalCost.toFixed(2)}.`, "error");

        btn.disabled = true; btn.textContent = 'PROCESSING...';
        try {
            await runTransaction(db, async (transaction) => {
                const senderRef = doc(db, "users", userData.tgChatId);
                const recipientRef = doc(db, "users", recipientUid);

                const [senderDoc, recipientDoc] = await Promise.all([
                    transaction.get(senderRef),
                    transaction.get(recipientRef)
                ]);

                if (!senderDoc.exists()) throw new Error("Your user data could not be found.");
                if (!recipientDoc.exists()) throw new Error("Recipient User ID not found.");
                
                const senderData = senderDoc.data();
                if (senderData.balance < totalCost) throw new Error("Insufficient balance for this transaction.");

                transaction.update(senderRef, { balance: senderData.balance - totalCost });
                transaction.update(recipientRef, { balance: recipientDoc.data().balance + amount });

                const logRef = doc(collection(db, "p2p_logs"));
                transaction.set(logRef, {
                    fromId: userData.tgChatId, fromName: userData.name,
                    toId: recipientUid, toName: recipientDoc.data().name || 'N/A',
                    amount: amount, fee: fee, status: "completed", createdAt: serverTimestamp()
                });
            });

            showModal(`<div class="text-center space-y-3"><i data-lucide="check-circle" class="w-12 h-12 text-emerald-500 mx-auto"></i><h3 class="text-lg font-bold text-white">Transfer Successful!</h3><p class="text-slate-400">Successfully sent $${amount} to UID ${recipientUid}.</p><button onclick="closeModal(); switchView('view-features');" class="action-btn w-full py-2 rounded-xl">OK</button></div>`);
            document.getElementById('p2p-uid').value = '';
            document.getElementById('p2p-amount').value = '';
        } catch (e) {
            showToast("Transfer failed: " + e.message, "error");
        } finally {
            btn.disabled = false; btn.textContent = 'CONFIRM TRANSFER';
            lucide.createIcons();
        }
    }

    function setupInteractions() {
        document.querySelectorAll('.dock-item').forEach(item => {
            item.addEventListener('click', () => switchView(item.dataset.target));
        });
        document.getElementById('btn-menu').addEventListener('click', () => {
            document.getElementById('main-side-panel').classList.add('open');
            document.getElementById('panel-overlay').classList.add('open');
        });
        document.getElementById('panel-overlay').addEventListener('click', closeSidePanel);
        document.getElementById('btn-notifications').addEventListener('click', loadNotifications);
        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('modal-backdrop').addEventListener('click', closeModal);
        document.getElementById('btn-copy-uid').addEventListener('click', () => copyText(userData.tgChatId));
        document.getElementById('btn-exec-p2p').addEventListener('click', executeP2PTransfer);
        
        const verifyBtn = document.getElementById('btn-verify-referral');
        if (verifyBtn) {
            verifyBtn.addEventListener('click', verifyReferralCode);
        }

        document.getElementById('dep-method-selector').addEventListener('click', () => {
            const options = [
                { value: 'USDT', text: 'USDT (TRC20)' },
                { value: 'BTC', text: 'BTC' },
                { value: 'Binance', text: 'Binance Pay' }
            ];
            showMethodSelector('dep-method', 'dep-method-text', 'Select Payment Method', options);
        });

        document.getElementById('wd-method-selector').addEventListener('click', () => {
            const options = [
                { value: 'USDT', text: 'USDT (TRC20)' },
                { value: 'BTC', text: 'BTC' },
                { value: 'Binance', text: 'Binance Pay ID' }
            ];
            showMethodSelector('wd-method', 'wd-method-text', 'Select Withdrawal Method', options);
        });

        document.getElementById('p2p-amount').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value) || 0;
            let feePercent = P2P_FEE_PERCENT;
            const isPremiumExpired = userData.premiumExpiry && userData.premiumExpiry.toDate() < new Date();
             if (userData.isPremium && !isPremiumExpired && premiumTiers[userData.premiumTier]?.benefits.feeReduction > 0) {
                feePercent -= premiumTiers[userData.premiumTier].benefits.feeReduction;
            }
            const fee = val * feePercent;
            document.getElementById('p2p-fee-calc').textContent = val > 0 ? `Fee (${(feePercent*100).toFixed(0)}%): $${fee.toFixed(2)}` : '';
        });
    }

    function initRealtimeListeners() {
         onSnapshot(doc(db, "users", userData.tgChatId), (doc) => {
            if(doc.exists()) {
                const oldData = {...userData};
                const newData = doc.data();
                userData = {...userData, ...newData};
                
                if (oldData.balance !== newData.balance || oldData.isPremium !== newData.isPremium || oldData.premiumTier !== newData.premiumTier) {
                     updateDashboard();
                }
                if (document.getElementById('view-tasks').classList.contains('active-view')) {
                    loadTasksView();
                }
            }
        });
    }

    async function loadProfileStats() {
        const statTasksEl = document.getElementById('stat-tasks');
        const statIncomeEl = document.getElementById('stat-income');
        const statReferralsEl = document.getElementById('stat-referrals');
    
        statTasksEl.textContent = '...';
        statIncomeEl.textContent = '...';
        statReferralsEl.textContent = '...';
    
        const uid = userData.tgChatId;
    
        try {
            const totalTasks = (userData.dailyCompletedTasks && Array.isArray(userData.dailyCompletedTasks)) ? userData.dailyCompletedTasks.length : 0;
            statTasksEl.textContent = totalTasks;
    
            const taskReward = TASK_REWARD; 
            const totalTaskEarnings = totalTasks * taskReward;
            statIncomeEl.textContent = `$${totalTaskEarnings.toFixed(2)}`;
    
            const referralsQuery = query(collection(db, "users"), where("referredBy", "==", uid));
            const referralsSnap = await getDocs(referralsQuery);
            statReferralsEl.textContent = referralsSnap.size;
    
        } catch (error) {
            console.error("Error loading profile stats:", error);
            statTasksEl.textContent = 'Error';
            statIncomeEl.textContent = 'Error';
            statReferralsEl.textContent = 'Error';
        }
    }

    async function loadActivityLog() {
        const el = document.getElementById('activity-log');
        el.innerHTML = '<div class="loader-ring w-6 h-6 border-2 mx-auto"></div>';
        
        let allLogs = [];

        try {
            const p2pQuery = query(collection(db, "p2p_logs"), where("fromId", "==", userData.tgChatId), orderBy("createdAt", "desc"), limit(5));
            const p2pSnap = await getDocs(p2pQuery);
            p2pSnap.forEach(d => { if(d.data().createdAt) allLogs.push({ ...d.data(), type: 'p2p' }); });
        } catch (error) { console.error("Error loading P2P logs:", error); }
        
        allLogs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        const recentLogs = allLogs.slice(0, 10);

        if (recentLogs.length === 0) {
            el.innerHTML = 'No recent activities found.';
            return;
        }

        el.innerHTML = recentLogs.map(log => {
            const date = log.createdAt.toDate().toLocaleDateString();
            if (log.type === 'p2p') {
                return `<div class="text-left p-2 rounded-lg bg-slate-900/50">
                            <p class="text-slate-300">Sent $${log.amount} to <span class="font-mono">${log.toId}</span></p>
                            <p class="text-slate-500 text-xs">${date}</p>
                        </div>`;
            }
            return '';
        }).join('');
    }

    async function loadNewsFeed() {
        const el = document.getElementById('news-feed');
        el.innerHTML = '<div class="flex justify-center p-8"><div class="loader-ring w-8 h-8 border-2"></div></div>';
        try {
            const q = query(collection(db, "news"), orderBy("createdAt", "desc"), limit(5));
            const snap = await getDocs(q);
            if (snap.empty) {
                el.innerHTML = '<p class="text-slate-500 text-center">No news available right now.</p>';
                return;
            }
            el.innerHTML = snap.docs.map(doc => {
                const news = doc.data();
                const date = news.createdAt.toDate().toLocaleString();
                return `
                <div class="neo-card p-4 rounded-2xl">
                    ${news.imageUrl ? `<img src="${news.imageUrl}" class="w-full h-40 object-cover rounded-xl mb-3" alt="news">` : ''}
                    <h3 class="font-bold text-lg text-slate-200">${news.title}</h3>
                    <p class="text-slate-400 text-sm mt-2">${news.content}</p>
                    <p class="text-xs text-slate-600 mt-3">${date}</p>
                </div>`;
            }).join('');
        } catch (error) {
            console.error("Error loading news:", error);
            el.innerHTML = '<p class="text-red-500 text-center">Could not load news feed.</p>';
        }
    }
</script>

</body>
</html>
